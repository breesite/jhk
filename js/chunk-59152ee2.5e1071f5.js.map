{"version":3,"sources":["webpack:///./src/views/ChatPage.vue","webpack:///./src/components/chat/ChatsList.vue","webpack:///./src/components/chat/ChatsList.vue?baec","webpack:///./src/components/chat/ChatsList.vue?bded","webpack:///./src/components/chat/MessagesHeader.vue","webpack:///./src/components/chat/SelectUsers.vue","webpack:///./src/components/chat/SelectUsers.vue?ac68","webpack:///./src/components/chat/SelectUsers.vue?d4d1","webpack:///./src/components/chat/MessagesHeader.vue?99fb","webpack:///./src/components/chat/MessagesHeader.vue?bad9","webpack:///./src/components/chat/MessagesView.vue","webpack:///./src/components/chat/MessageItem.vue","webpack:///./src/components/chat/MessageItem.vue?d8ae","webpack:///./src/components/chat/MessageItem.vue?73be","webpack:///./src/components/chat/MessagesView.vue?edb3","webpack:///./src/components/chat/MessagesView.vue?dbfc","webpack:///./src/components/chat/SendSection.vue","webpack:///./src/components/chat/SendSection.vue?508e","webpack:///./src/components/chat/SendSection.vue?7665","webpack:///./src/views/ChatPage.vue?f1e5","webpack:///./src/views/ChatPage.vue?b234","webpack:///./src/components/chat/MessagesView.vue?482d","webpack:///./src/components/chat/SendSection.vue?8a28","webpack:///./src/components/chat/SendSection.vue?b112","webpack:///./src/views/ChatPage.vue?b4b8","webpack:///./src/components/chat/SelectUsers.vue?bce0","webpack:///./src/components/chat/ChatsList.vue?6d93","webpack:///./src/components/chat/MessagesHeader.vue?32b9","webpack:///./src/components/chat/MessageItem.vue?d077"],"names":["class","isMobile","$router","go","chat-id","chatId","show-message-view","showMessageView","createLoading","chat","ref","sendSuccess","appendIncomingMessage","loading","type","chatsData","length","infinite-scroll-disabled","hasMorePages","key","id","removeChat","src","users","icon","withUser","avatar","alt","subject","name","lastMessage","loadMore","loadingMore","props","Number","Function","components","Skeleton","LoadingSpinner","setup","route","isFirst","query","user_id","chat_id","deleteChatMutation","mutate","store","me","state","user","value","enabled","chats","data","methods","currentChat","index","findIndex","splice","err","error","message","last_message_id","render","__scopeId","t","viewBox","version","xmlns","p-id","d","chatName","dropdown","showUsersModal","isGroupChat","isGroupOwner","toggleVisible","deleteGroupChat","editDialogVisible","custom-class","title","width","center","footer","updateChat","groupName","maxlength","show-word-limit","placeholder","fill","fill-rule","clip-rule","infinite-scroll-distance","visible","destroy-on-close","clearable","content","onSearch","prefix","selectedPerson","onFinish","addLoading","deleteLoading","count","searchUsers","item","label","disabled","isDisabled","description","isAdd","Array","default","Empty","keywords","operation","isArray","disabledUids","ids","filter","push","fetchPolicy","refetch","q","text","variables","uids","concat","refetchQueries","createChatMutation","addMembersMutation","deleteMembersMutation","res","this","mounted","$bus","on","Object","SelectUsers","deleteUids","map","updateChatMutate","deleteMembersMutate","deleteChatMutate","isDisband","removeParticipantsInGroupChat","deleteChat","emit","loadLastPageMessages","messagesData","messages-data","$attrs","date","isSelf","messageStatus","parsingEmoji","body","url","context","userId","moment","messageDateStr","created_at","payload","sendMessageMutate","sendMessage","console","log","MessageItem","messages","currentPage","scrollHeight","scrollToPosition","position","ele","document","getElementById","setTimeout","clientHeight","scrollTop","appendMessageObj","msgObj","prototype","toString","call","action","accept","before-upload","onBeforeUpload","popper-class","placement","trigger","reference","emojiList","emoji","insetEmoji","sendPayloadMessage","messageObj","__typename","messageable","messageable_id","messageable_type","time_ago","imageUrl","messagesViewRef","payloadMessage","isTextMessage","incomingMessage","Date","getTime","messageType","emojiTitle","inner","inputElement","querySelector","selectionStart","startPos","endPos","selectionEnd","inputValue","substring","focus","setSelectionRange","file","reader","FileReader","readAsDataURL","onload","e","target","result","ChatsList","MessagesHeader","MessagesView","SendSection","router","chatResult","sendSectionRef","appendMessage","onSendSuccess","isNeedCreate","LegalUids","createChat","replace","computed","uaInfo","navigator","userAgent","match"],"mappings":"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","file":"js/chunk-59152ee2.5e1071f5.js","sourcesContent":["<template>\n  <div :class=\"[isMobile && 'hide-masthead']\">\n    <Masthead />\n  </div>\n  <div class=\"chat-page\">\n    <div class=\"fluid-content\">\n      <div class=\"container\">\n        <div class=\"left\">\n          <div class=\"list-header text-ellipsis\">\n            <i class=\"el-icon-arrow-left back-icon\" @click=\"$router.go(-1)\"></i>\n            <span>聊天列表</span>\n          </div>\n          <ChatsList v-loading=\"createLoading\" :chat-id=\"chatId\" :show-message-view=\"showMessageView\" />\n        </div>\n        <div class=\"right\">\n          <MessagesHeader :chat=\"chat\" />\n          <MessagesView ref=\"messagesViewRef\" :chat-id=\"chatId\" @sendSuccess=\"sendSuccess\" />\n          <div class=\"send-box\">\n            <SendSection ref=\"sendSectionRef\" :chat-id=\"chatId\" @appendMessage=\"appendIncomingMessage\" />\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { ref, watch, onMounted } from 'vue';\nimport { useStore } from 'vuex';\nimport { useRoute, useRouter } from 'vue-router';\nimport { ElMessage } from 'element-plus';\nimport { useMutation, useQuery } from '@vue/apollo-composable';\nimport { CREATE_CHAT_MUTATION, CHAT_QUERY, CHATS_QUERY } from '@/graphql';\nimport { exceptionCapture, errorMessage } from '@/utils';\nimport ChatsList from '@/components/chat/ChatsList.vue';\nimport MessagesHeader from '@/components/chat/MessagesHeader.vue';\nimport MessagesView from '@/components/chat/MessagesView.vue';\nimport SendSection from '@/components/chat/SendSection.vue';\n\nexport default {\n  components: {\n    ChatsList,\n    MessagesHeader,\n    MessagesView,\n    SendSection\n  },\n  setup() {\n    const route = useRoute();\n    const router = useRouter();\n    const store = useStore();\n    const me = ref(store.state?.user?.user);\n\n    const chatId = ref(Number(route?.query?.chat_id));\n    const userId = ref(Number(route?.query?.user_id));\n    const uids = ref([me.value?.id, userId.value]);\n    const chat = ref({ id: chatId.value });\n\n    function showMessageView(currentChat) {\n      if (currentChat?.id) {\n        chatId.value = currentChat?.id;\n        chat.value = currentChat;\n      }\n    }\n\n    const { result } = useQuery(CHAT_QUERY, { chat_id: chatId.value }, { enabled: !!chatId.value });\n    watch(result, () => {\n      const chatResult = result.value?.chat;\n      showMessageView(chatResult);\n    });\n\n    const { mutate: createChatMutation, loading: createLoading } = useMutation(CREATE_CHAT_MUTATION, () => ({\n      variables: { uids: uids.value },\n      refetchQueries: () => [\n        {\n          query: CHATS_QUERY,\n          variables: { user_id: me.value?.id }\n        }\n      ]\n    }));\n\n    const messagesViewRef = ref(null);\n    const sendSectionRef = ref(null);\n\n    function appendIncomingMessage(incomingMessage) {\n      // appendMessageObj：消息列表组件中的函数。用于追加 incomingMessage 对象到消息列表，并滚动到消息列表底部\n      const appendMessage = messagesViewRef.value?.appendMessageObj;\n      if (incomingMessage && Object.prototype.toString.call(appendMessage) === '[object Function]') {\n        appendMessage(incomingMessage);\n      }\n    }\n\n    function sendSuccess() {\n      // sendSuccess：发送框组件中的函数。用于消息发送成功后清空输入框的内容\n      const onSendSuccess = sendSectionRef.value?.sendSuccess;\n      if (Object.prototype.toString.call(onSendSuccess) === '[object Function]') {\n        onSendSuccess();\n      }\n    }\n\n    onMounted(async () => {\n      const isNeedCreate = !chatId.value && me.value?.id && userId.value;\n      const LegalUids = Array.isArray(uids.value) && uids.value?.length > 1;\n      if (isNeedCreate && LegalUids) {\n        console.log('创建聊天');\n        const [err, res] = await exceptionCapture(() => createChatMutation());\n        if (err) {\n          ElMessage.error(`创建聊天失败：${errorMessage(err)}`);\n        } else if (res?.data.createChat) {\n          showMessageView(res?.data.createChat);\n        }\n      }\n    });\n\n    watch(chatId, () => {\n      router.replace({ query: { chat_id: Number(chatId.value) } });\n    });\n\n    return {\n      chat,\n      chatId,\n      createLoading,\n      showMessageView,\n      messagesViewRef,\n      sendSectionRef,\n      appendIncomingMessage,\n      sendSuccess\n    };\n  },\n  computed: {\n    isMobile() {\n      const uaInfo = navigator.userAgent.match(\n        /(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i\n      );\n      console.log('mobile', !!uaInfo);\n      return !!uaInfo;\n    }\n  }\n};\n</script>\n\n<style lang=\"scss\" scoped>\n$bg-color: #fff2f6;\n$border-color: #e9eaec;\n\n.chat-page {\n  width: 100%;\n  padding: 30px 0;\n  font-size: 15px;\n  line-height: 22px;\n  box-sizing: border-box;\n  background-color: $bg-color;\n}\n.container {\n  display: flex;\n  flex-direction: row;\n  justify-content: center;\n  max-width: 1200px;\n  height: calc(100vh - 60px - var(--header-height));\n  margin: 0 auto;\n  border: 1px solid $border-color;\n  border-radius: 6px;\n  box-shadow: 0 2px 4px 0 rgb(254 220 231 / 54%);\n  background-color: #fff;\n}\n.left {\n  flex: 1;\n  display: flex;\n  flex-direction: column;\n  border-right: 1px solid $border-color;\n  overflow: hidden;\n  .list-header {\n    // font-size: 14px;\n    // color: #333;\n    height: 42px;\n    padding: 0 15px;\n    display: flex;\n    align-items: center;\n    border-bottom: 1px solid $border-color;\n    .back-icon {\n      font-size: 18px;\n      margin-right: 10px;\n    }\n  }\n}\n.right {\n  flex: 3;\n  display: flex;\n  flex-direction: column;\n  overflow: hidden;\n\n  .send-box {\n    height: 182px;\n    border-top: 1px solid #d8d8d8;\n    border-bottom-right-radius: 6px;\n    background-color: #f4f5f7;\n    flex-shrink: 0;\n    position: relative;\n    z-index: 2;\n  }\n}\n@import '@/scss/views/chat-page.scss';\n</style>\n","<template>\n  <div class=\"chats-wrap\">\n    <div v-if=\"loading\" class=\"loading-box\">\n      <Skeleton type=\"comments\" />\n    </div>\n    <ul\n      v-else-if=\"chatsData?.length\"\n      class=\"chats-list\"\n      v-infinite-scroll=\"loadMore\"\n      :infinite-scroll-disabled=\"!hasMorePages\"\n    >\n      <li\n        v-for=\"chat in chatsData\"\n        :key=\"chat?.id\"\n        :class=\"['chat-item', chatId === chat?.id && 'active']\"\n        @click=\"showMessageView(chat)\"\n      >\n        <div class=\"close-icon\" @click=\"removeChat(chat)\">\n          <i class=\"el-icon-close\"></i>\n        </div>\n        <div class=\"avatar-box\">\n          <img :src=\"chat?.users?.length > 2 ? chat?.icon : chat?.withUser?.avatar\" alt=\"avatar\" class=\"user-avatar\" />\n        </div>\n        <div class=\"chat-info\">\n          <div class=\"user-name text-ellipsis\">\n            {{ chat?.users?.length > 2 ? chat?.subject || '匿名群聊' : chat?.withUser?.name }}\n          </div>\n          <div class=\"last-message text-ellipsis\">\n            <span v-html=\"lastMessage(chat)\"> </span>\n          </div>\n        </div>\n      </li>\n    </ul>\n    <LoadingSpinner v-if=\"loadingMore\" />\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { ref, watch, toRefs } from 'vue';\nimport { useStore } from 'vuex';\nimport { useRoute } from 'vue-router';\nimport { ElMessage } from 'element-plus';\nimport { parsingEmoji } from 'vemoji-list';\nimport { useMutation } from '@vue/apollo-composable';\nimport { exceptionCapture, errorMessage } from '@/utils';\nimport { DELETE_CHAT_MUTATION, useChatsQuery } from '@/graphql';\nimport Skeleton from '../Skeleton.vue';\nimport LoadingSpinner from '../LoadingSpinner.vue';\n\nexport default {\n  name: 'ChatsList',\n  props: {\n    chatId: Number,\n    showMessageView: Function\n  },\n  components: {\n    Skeleton,\n    LoadingSpinner\n  },\n  setup(props) {\n    const route = useRoute();\n    const { showMessageView, chatId } = toRefs(props);\n    const isFirst = ref(!(route.query?.user_id || route.query?.chat_id));\n\n    const { mutate: deleteChatMutation } = useMutation(DELETE_CHAT_MUTATION);\n\n    const store = useStore();\n    const me = ref(store.state?.user?.user);\n    const { chats, loading, hasMorePages, loadMore, loadingMore } = useChatsQuery(\n      { user_id: me.value?.id },\n      { enabled: !!me.value?.id }\n    );\n    const chatsData = ref(chats.value);\n\n    watch(chats, data => {\n      chatsData.value = [...data];\n      if (isFirst.value) {\n        showMessageView.value(data?.[0] || {});\n      }\n    });\n\n    return {\n      chatId,\n      chatsData,\n      loading,\n      hasMorePages,\n      loadMore,\n      loadingMore,\n      deleteChatMutation,\n      showMessageView\n    };\n  },\n  methods: {\n    async removeChat(currentChat) {\n      if (currentChat?.id) {\n        const index = this.chatsData.findIndex(chat => chat.id === currentChat.id);\n        this.chatsData?.splice(index, 1);\n        const [err, res] = await exceptionCapture(() => this.deleteChatMutation({ chat_id: currentChat?.id }));\n        if (err) {\n          ElMessage.error(`删除聊天失败：${errorMessage(err)}`);\n          this.chatsData?.splice(index, 0, currentChat);\n        }\n      } else {\n        ElMessage.error('当前聊天信息丢失');\n      }\n    },\n    lastMessage(chat) {\n      return parsingEmoji(chat?.lastMessage?.message || (chat?.last_message_id ? '' : '“还没有发过消息”'));\n    }\n  }\n};\n</script>\n\n<style lang=\"scss\" scoped>\n.chats-wrap {\n  flex: 1;\n  position: relative;\n  overflow-x: hidden;\n  overflow-y: auto;\n  background-color: #fff;\n}\n::-webkit-scrollbar-track {\n  // background-color: #f4f5f7;\n  background-color: transparent;\n}\n.loading-box {\n  padding: 0 20px;\n}\n.chats-list {\n  .chat-item {\n    flex: 1;\n    display: flex;\n    flex-direction: row;\n    padding: 20px;\n    position: relative;\n    background-color: #ffffff;\n    cursor: pointer;\n    .close-icon {\n      position: absolute;\n      left: -16px;\n      top: 20px;\n      display: block;\n      height: 48px;\n      transition: transform ease-out 0.25s;\n      opacity: 0;\n      .el-icon-close {\n        color: #999;\n        font-size: 18px;\n        font-weight: 500;\n        line-height: 48px;\n      }\n    }\n    .avatar-box {\n      margin-right: 10px;\n      .user-avatar {\n        width: 48px;\n        height: 48px;\n        border-radius: 24px;\n      }\n    }\n    .chat-info {\n      flex: 1;\n      display: flex;\n      flex-direction: column;\n      justify-content: space-around;\n      min-width: 0; // 防止文字溢出\n      .user-name {\n        flex: 1;\n        font-size: 15px;\n        line-height: 22px;\n      }\n      .last-message {\n        color: #999;\n        font-size: 13px;\n        font-weight: 500;\n        line-height: 20px;\n      }\n    }\n    &:hover {\n      background-color: #f5f5f6;\n      .close-icon {\n        opacity: 1;\n        transform: translateX(16px);\n      }\n    }\n    &.active {\n      background-color: #e4e5e6;\n    }\n  }\n}\n@import '@/scss/views/chat-page.scss';\n</style>\n","\nimport { ref, watch, toRefs } from 'vue';\nimport { useStore } from 'vuex';\nimport { useRoute } from 'vue-router';\nimport { ElMessage } from 'element-plus';\nimport { parsingEmoji } from 'vemoji-list';\nimport { useMutation } from '@vue/apollo-composable';\nimport { exceptionCapture, errorMessage } from '@/utils';\nimport { DELETE_CHAT_MUTATION, useChatsQuery } from '@/graphql';\nimport Skeleton from '../Skeleton.vue';\nimport LoadingSpinner from '../LoadingSpinner.vue';\n\nexport default {\n  name: 'ChatsList',\n  props: {\n    chatId: Number,\n    showMessageView: Function\n  },\n  components: {\n    Skeleton,\n    LoadingSpinner\n  },\n  setup(props) {\n    const route = useRoute();\n    const { showMessageView, chatId } = toRefs(props);\n    const isFirst = ref(!(route.query?.user_id || route.query?.chat_id));\n\n    const { mutate: deleteChatMutation } = useMutation(DELETE_CHAT_MUTATION);\n\n    const store = useStore();\n    const me = ref(store.state?.user?.user);\n    const { chats, loading, hasMorePages, loadMore, loadingMore } = useChatsQuery(\n      { user_id: me.value?.id },\n      { enabled: !!me.value?.id }\n    );\n    const chatsData = ref(chats.value);\n\n    watch(chats, data => {\n      chatsData.value = [...data];\n      if (isFirst.value) {\n        showMessageView.value(data?.[0] || {});\n      }\n    });\n\n    return {\n      chatId,\n      chatsData,\n      loading,\n      hasMorePages,\n      loadMore,\n      loadingMore,\n      deleteChatMutation,\n      showMessageView\n    };\n  },\n  methods: {\n    async removeChat(currentChat) {\n      if (currentChat?.id) {\n        const index = this.chatsData.findIndex(chat => chat.id === currentChat.id);\n        this.chatsData?.splice(index, 1);\n        const [err, res] = await exceptionCapture(() => this.deleteChatMutation({ chat_id: currentChat?.id }));\n        if (err) {\n          ElMessage.error(`删除聊天失败：${errorMessage(err)}`);\n          this.chatsData?.splice(index, 0, currentChat);\n        }\n      } else {\n        ElMessage.error('当前聊天信息丢失');\n      }\n    },\n    lastMessage(chat) {\n      return parsingEmoji(chat?.lastMessage?.message || (chat?.last_message_id ? '' : '“还没有发过消息”'));\n    }\n  }\n};\n","import { render } from \"./ChatsList.vue?vue&type=template&id=091678a4&scoped=true\"\nimport script from \"./ChatsList.vue?vue&type=script&lang=ts\"\nexport * from \"./ChatsList.vue?vue&type=script&lang=ts\"\n\nimport \"./ChatsList.vue?vue&type=style&index=0&id=091678a4&lang=scss&scoped=true\"\nscript.render = render\nscript.__scopeId = \"data-v-091678a4\"\n\nexport default script","<template>\n  <div>\n    <div class=\"message-header\">\n      <div></div>\n      <span>{{ chatName }}</span>\n      <div class=\"right-box\">\n        <el-dropdown v-if=\"chat?.users?.length\">\n          <div class=\"more-icon\">\n            <svg\n              t=\"1637906984352\"\n              class=\"icon\"\n              viewBox=\"0 0 1024 1024\"\n              version=\"1.1\"\n              xmlns=\"http://www.w3.org/2000/svg\"\n              p-id=\"1302\"\n            >\n              <path\n                d=\"M697.83096889 63.39394333A484.0440411 484.0440411 0 0 0 512 26.54814777C243.88494222 26.54814777 26.54814777 243.88494222 26.54814777 512s217.33679445 485.45185223 485.45185223 485.45185223 485.45185223-217.33679445 485.45185223-485.45185223c0-64.56509667-12.62174777-127.43111111-36.84579556-185.83096889a24.27259221 24.27259221 0 0 0-44.83147889 18.59280555A435.49885667 435.49885667 0 0 1 948.90666667 512c0 241.29384334-195.61282333 436.90666667-436.90666667 436.90666667S75.09333333 753.29384334 75.09333333 512 270.70615666 75.09333333 512 75.09333333c58.15713223 0 114.688 11.35957333 167.23816334 33.13208889a24.27259221 24.27259221 0 0 0 18.59280555-44.83147889zM269.27407445 560.54518557a48.54518557 48.54518557 0 1 0 0-97.09037114 48.54518557 48.54518557 0 0 0 0 97.09037114z m242.72592555 0a48.54518557 48.54518557 0 1 0 0-97.09037114 48.54518557 48.54518557 0 0 0 0 97.09037114z m242.72592555 0a48.54518557 48.54518557 0 1 0 0-97.09037114 48.54518557 48.54518557 0 0 0 0 97.09037114z\"\n                p-id=\"1303\"\n              ></path>\n            </svg>\n          </div>\n          <template #dropdown>\n            <el-dropdown-menu>\n              <el-dropdown-item>\n                <div class=\"dropdown-item\" @click=\"showUsersModal('add')\">\n                  {{ isGroupChat ? '邀请成员' : '创建群聊' }}\n                </div>\n              </el-dropdown-item>\n              <div v-if=\"isGroupChat\">\n                <el-dropdown-item v-if=\"isGroupOwner\">\n                  <div class=\"dropdown-item\" @click=\"showUsersModal('delete')\">移除成员</div>\n                </el-dropdown-item>\n                <el-dropdown-item v-if=\"isGroupOwner\">\n                  <div class=\"dropdown-item\" @click=\"toggleVisible\">修改群名</div>\n                </el-dropdown-item>\n                <el-dropdown-item>\n                  <div class=\"dropdown-item\" @click=\"deleteGroupChat\">{{ isGroupOwner ? '解散群聊' : '退出群聊' }}</div>\n                </el-dropdown-item>\n              </div>\n            </el-dropdown-menu>\n          </template>\n        </el-dropdown>\n      </div>\n    </div>\n\n    <SelectUsers :users=\"chat?.users\" :chat-id=\"chat?.id\" />\n    <el-dialog v-model=\"editDialogVisible\" custom-class=\"groupName-modal\" title=\"修改群名\" width=\"90%\" center>\n      <el-input\n        v-model=\"groupName\"\n        class=\"name-input\"\n        maxlength=\"15\"\n        show-word-limit\n        :placeholder=\"chat?.subject || '群聊名称'\"\n      ></el-input>\n      <template #footer>\n        <el-button @click=\"toggleVisible\">取消</el-button>\n        <el-button type=\"primary\" @click=\"updateChat\">修改</el-button>\n      </template>\n    </el-dialog>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { toRefs, computed, ref } from 'vue';\nimport { useStore } from 'vuex';\nimport { ElMessage } from 'element-plus';\nimport { useMutation } from '@vue/apollo-composable';\nimport { exceptionCapture, errorMessage } from '@/utils';\nimport {\n  UPDATE_CHAT_MUTATION,\n  DELETE_MEMBERS_MUTATION,\n  DELETE_CHAT_MUTATION,\n  CHATS_QUERY,\n  CHAT_QUERY\n} from '@/graphql';\nimport SelectUsers from './SelectUsers.vue';\n\nexport default {\n  props: {\n    chat: Object\n  },\n  components: {\n    SelectUsers\n  },\n  setup(props) {\n    const { chat } = toRefs(props);\n    const store = useStore();\n    const me = ref(store.state?.user?.user);\n    const isGroupChat = computed(() => chat.value?.users?.length > 2);\n    const isGroupOwner = computed(() => me.value?.id && chat.value?.user?.id === me.value?.id);\n    const chatName = computed(() =>\n      isGroupChat.value ? chat.value?.subject || '匿名群聊' : chat.value?.withUser?.name || '聊天消息'\n    );\n\n    const deleteUids = computed(() => {\n      if (isGroupOwner.value) {\n        // 解散群聊的用户ids\n        let users = [];\n        chat.value?.users.map(user => {\n          user?.id && users.push(user?.id);\n        });\n        return users;\n      } else {\n        // 退出群聊的用户id\n        return [me.value?.id];\n      }\n    });\n\n    const groupName = ref('');\n    const editDialogVisible = ref(false);\n    const { mutate: updateChatMutate } = useMutation(UPDATE_CHAT_MUTATION, () => ({\n      variables: {\n        chat_id: chat.value?.id,\n        subject: groupName.value\n      }\n    }));\n\n    const { mutate: deleteMembersMutate } = useMutation(DELETE_MEMBERS_MUTATION, () => ({\n      variables: {\n        chat_id: chat.value?.id,\n        uids: deleteUids.value\n      },\n      refetchQueries: () => [\n        {\n          query: CHATS_QUERY,\n          variables: { user_id: me.value?.id }\n        },\n        {\n          query: CHAT_QUERY,\n          variables: { chat_id: chat.value?.id }\n        }\n      ]\n    }));\n\n    const { mutate: deleteChatMutate } = useMutation(DELETE_CHAT_MUTATION, () => ({\n      variables: { chat_id: chat.value?.id },\n      refetchQueries: () => [\n        {\n          query: CHATS_QUERY,\n          variables: { user_id: me.value?.id }\n        },\n        {\n          query: CHAT_QUERY,\n          variables: { chat_id: chat.value?.id }\n        }\n      ]\n    }));\n\n    async function updateChat() {\n      if (!groupName.value?.length) {\n        ElMessage.error('请输入群聊名称');\n        return;\n      }\n      const [err, res] = await exceptionCapture(() => updateChatMutate());\n      if (err) {\n        ElMessage.error(`修改失败：${errorMessage(err)}`);\n      } else if (res?.data.updateChat) {\n        editDialogVisible.value = false;\n        ElMessage({ message: '修改成功', type: 'success' });\n      }\n    }\n\n    async function deleteGroupChat() {\n      // 是否解散群聊（是群主则解散群聊，否则仅退出群聊）\n      const isDisband = isGroupOwner.value;\n      if (chat.value?.id && deleteUids.value) {\n        const [err, res] = await exceptionCapture(() => (isDisband ? deleteChatMutate() : deleteMembersMutate()));\n        if (err) {\n          ElMessage.error(`退群失败：${errorMessage(err) || (isDisband ? '解散群聊失败！' : '退群失败！')}`);\n        } else if (res?.data?.removeParticipantsInGroupChat) {\n          ElMessage({ message: '你已退出该群！', type: 'success' });\n        } else if (res?.data?.deleteChat) {\n          ElMessage({ message: '已解散群聊！', type: 'success' });\n        }\n      } else {\n        ElMessage.error('群聊信息丢失!');\n      }\n    }\n\n    return {\n      chat,\n      chatName,\n      isGroupChat,\n      isGroupOwner,\n      groupName,\n      editDialogVisible,\n      updateChat,\n      deleteGroupChat\n    };\n  },\n  methods: {\n    toggleVisible() {\n      this.editDialogVisible = !this.editDialogVisible;\n    },\n    showUsersModal(operation: 'add' | 'delete') {\n      if (operation) {\n        this.$bus.emit('SHOW_USERS_MODAL', operation);\n      }\n    }\n  }\n};\n</script>\n\n<style lang=\"scss\" scoped>\n$border-color: #e9eaec;\n\n.message-header {\n  height: 42px;\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  padding: 0 15px;\n  color: #333;\n  border-bottom: 1px solid $border-color;\n  .right-box {\n    display: flex;\n    align-items: center;\n    .more-icon {\n      width: 2.2rem;\n      height: 2.2rem;\n      .icon {\n        fill: var(--color-text-2);\n        user-select: none;\n      }\n    }\n  }\n}\n.el-dropdown-menu .el-dropdown-menu__item {\n  text-align: center;\n}\n\n// 穿透 el-dialog style\n:deep(.el-dialog.groupName-modal) {\n  max-width: 428px;\n  .el-dialog__header {\n    .el-dialog__title {\n      font-size: 16px;\n    }\n  }\n}\n</style>\n","<template>\n  <div id=\"users-dialog\" v-if=\"visible\">\n    <el-dialog v-model=\"visible\" custom-class=\"users-modal\" width=\"90%\" :destroy-on-close=\"true\" center>\n      <div class=\"search-user-bar\">\n        <el-input\n          clearable\n          class=\"search-input\"\n          v-model=\"content\"\n          :placeholder=\"`${content || '搜索用户'}`\"\n          @keyup.enter=\"onSearch\"\n          @clear=\"onSearch({ q: '' })\"\n        >\n          <template #prefix>\n            <div class=\"input-icon\">\n              <svg class=\"icon\" fill=\"rgba(47, 48, 53, 0.4)\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 18 18\">\n                <path\n                  fill-rule=\"evenodd\"\n                  clip-rule=\"evenodd\"\n                  d=\"M7.875 1.5a6.375 6.375 0 103.642 11.608l3.063 3.063a1.125 1.125 0 001.59-1.591l-3.062-3.063A6.375 6.375 0 007.875 1.5zM3.75 7.875a4.125 4.125 0 118.25 0 4.125 4.125 0 01-8.25 0z\"\n                ></path>\n              </svg>\n            </div>\n          </template>\n        </el-input>\n        <div\n          :class=\"['input-button', selectedPerson?.length && 'active']\"\n          @click=\"selectedPerson?.length && onFinish()\"\n        >\n          <span class=\"btn-title\">完成</span>\n          <i class=\"el-icon-loading\" v-if=\"createLoading || addLoading || deleteLoading\" />\n        </div>\n      </div>\n\n      <div class=\"list-content\" v-show=\"isAdd\">\n        <div v-if=\"loading\">\n          <div class=\"skeleton-wrap\">\n            <Skeleton type=\"comments\" :count=\"10\" />\n          </div>\n        </div>\n        <template v-else-if=\"searchUsers?.length > 0\">\n          <div v-infinite-scroll=\"loadMore\" infinite-scroll-distance=\"300\" infinite-scroll-disabled=\"disabled\">\n            <el-checkbox-group v-model=\"selectedPerson\">\n              <el-checkbox\n                class=\"user-item-wrap\"\n                v-for=\"item in searchUsers\"\n                :key=\"'search' + item?.id\"\n                :label=\"item?.id\"\n                :disabled=\"isDisabled(item?.id)\"\n              >\n                <img :src=\"item?.avatar\" alt=\"\" class=\"user-avatar\" />\n                <span class=\"user-name text-ellipsis\">{{ item?.name }}</span>\n              </el-checkbox>\n            </el-checkbox-group>\n          </div>\n          <LoadingSpinner v-if=\"hasMorePages\" />\n        </template>\n        <Empty v-else type=\"content\" description=\"暂无内容\" />\n      </div>\n\n      <div class=\"list-content\" v-show=\"!isAdd\">\n        <el-checkbox-group v-if=\"users?.length > 0\" v-model=\"selectedPerson\">\n          <el-checkbox\n            class=\"user-item-wrap\"\n            v-for=\"item in users\"\n            :key=\"'search' + item?.id\"\n            :label=\"item?.id\"\n            :disabled=\"isDisabled(item?.id)\"\n          >\n            <img :src=\"item?.avatar\" alt=\"\" class=\"user-avatar\" />\n            <span class=\"user-name text-ellipsis\">{{ item?.name }}</span>\n          </el-checkbox>\n        </el-checkbox-group>\n        <Empty v-else type=\"content\" description=\"暂无内容\" />\n      </div>\n    </el-dialog>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { defineComponent, ref, watch, toRefs, computed } from 'vue';\nimport { useStore } from 'vuex';\nimport { ElMessage } from 'element-plus';\nimport { useMutation } from '@vue/apollo-composable';\nimport { exceptionCapture, errorMessage } from '@/utils';\nimport {\n  CREATE_CHAT_MUTATION,\n  ADD_MEMBERS_MUTATION,\n  DELETE_MEMBERS_MUTATION,\n  CHATS_QUERY,\n  CHAT_QUERY,\n  useSearchUsersQuery\n} from '@/graphql';\nimport Skeleton from '../Skeleton.vue';\nimport LoadingSpinner from '../LoadingSpinner.vue';\nimport Empty from '../Empty.vue';\n\nexport default defineComponent({\n  props: {\n    users: {\n      type: Array,\n      default: []\n    },\n    chatId: {\n      type: Number\n    }\n  },\n  components: {\n    Skeleton,\n    LoadingSpinner,\n    Empty\n  },\n  setup(props) {\n    const { users, chatId } = toRefs(props);\n    const store = useStore();\n    const me = ref(store.state?.user?.user);\n    const visible = ref(false);\n    const content = ref('');\n    const keywords = ref('');\n    const operation = ref('');\n    const selectedPerson = ref([]); // 已选中的用户ID\n\n    const isAdd = computed(() => operation.value === 'add');\n    const isGroupChat = computed(() => {\n      return Array.isArray(users.value) && users.value?.length > 2;\n    });\n    const disabledUids = computed(() => {\n      let ids = [];\n      if (isAdd.value && Array.isArray(users.value)) {\n        users.value.filter(user => user?.id && ids.push(user?.id));\n      }\n      return ids;\n    });\n\n    const { loading, searchUsers, refetch, disabled, loadMore, hasMorePages } = useSearchUsersQuery(\n      { keywords },\n      { fetchPolicy: 'network-only' }\n    );\n\n    const onSearch = ({ q }) => {\n      const text = q || content.value || '';\n      content.value = text;\n      keywords.value = text;\n      refetch();\n    };\n\n    const { mutate: createChatMutation, loading: createLoading } = useMutation(CREATE_CHAT_MUTATION, () => ({\n      variables: { uids: selectedPerson.value.concat(disabledUids.value), type: 'GROUP_TYPE' },\n      refetchQueries: () => [\n        {\n          query: CHATS_QUERY,\n          variables: { user_id: me.value?.id }\n        }\n      ]\n    }));\n\n    const { mutate: addMembersMutation, loading: addLoading } = useMutation(ADD_MEMBERS_MUTATION, () => ({\n      variables: {\n        chat_id: chatId.value,\n        uids: selectedPerson.value\n      },\n      refetchQueries: () => [\n        {\n          query: CHATS_QUERY,\n          variables: { user_id: me.value?.id }\n        },\n        {\n          query: CHAT_QUERY,\n          variables: { chat_id: chatId.value }\n        }\n      ]\n    }));\n\n    const { mutate: deleteMembersMutation, loading: deleteLoading } = useMutation(DELETE_MEMBERS_MUTATION, () => ({\n      variables: {\n        chat_id: chatId.value,\n        uids: selectedPerson.value\n      },\n      refetchQueries: () => [\n        {\n          query: CHATS_QUERY,\n          variables: { user_id: me.value?.id }\n        },\n        {\n          query: CHAT_QUERY,\n          variables: { chat_id: chatId.value }\n        }\n      ]\n    }));\n\n    async function onFinish() {\n      const [err, res] = await exceptionCapture(() => {\n        if (isAdd.value) {\n          if (isGroupChat.value) {\n            return addMembersMutation(); // 添加成员\n          } else {\n            return createChatMutation(); // 创建群聊\n          }\n        } else {\n          return deleteMembersMutation(); // 移除成员\n        }\n      });\n      if (err) {\n        ElMessage.error(`操作失败：${errorMessage(err)}`);\n      } else if (res) {\n        visible.value = false;\n        ElMessage({ message: '操作成功', type: 'success' });\n      }\n    }\n\n    return {\n      visible,\n      content,\n      onSearch,\n      isAdd,\n      loading,\n      searchUsers,\n      refetch,\n      disabled,\n      loadMore,\n      hasMorePages,\n      operation,\n      disabledUids,\n      selectedPerson,\n      createLoading,\n      addLoading,\n      deleteLoading,\n      onFinish\n    };\n  },\n  methods: {\n    isDisabled(user_id) {\n      return this.disabledUids.findIndex(id => id === user_id) !== -1;\n    }\n  },\n  mounted() {\n    this.$bus.on('SHOW_USERS_MODAL', (operation: 'add' | 'delete') => {\n      if (operation) {\n        this.operation = operation;\n        this.visible = true;\n        this.selectedPerson = [];\n        this.refetch();\n      }\n    });\n  }\n});\n</script>\n\n<style lang=\"scss\" scoped>\n$icon-height: 20px;\n$input-bg-color: #f6f6f6;\n\n.search-user-bar .search-input {\n  .input-icon {\n    width: $icon-height;\n    height: $icon-height;\n    margin-top: 5px;\n    fill: rgba(47, 48, 53, 0.4);\n  }\n}\n.input-button {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  min-width: 60px;\n  padding: 0 15px;\n  margin-left: 10px;\n  border-radius: 4px;\n  background-color: $input-bg-color;\n  cursor: pointer;\n  .btn-title {\n    color: rgba(47, 48, 53, 0.9);\n    font-size: 14px;\n    font-weight: 500;\n    line-height: 22px;\n  }\n  .el-icon-loading {\n    color: #ffffff;\n    font-size: 14px;\n    font-weight: bold;\n    margin-left: 3px;\n  }\n  &.active {\n    background-color: $theme-color_primary;\n    .btn-title {\n      color: #ffffff;\n    }\n  }\n}\n\n.list-content {\n  height: 380px;\n  padding-right: 10px;\n  overflow: auto;\n  .skeleton-wrap {\n    display: block;\n    padding: 10px 0;\n  }\n  // 穿透 checkbox style\n  :deep(.el-checkbox.user-item-wrap) {\n    display: flex;\n    align-items: center;\n    margin: 8px 0;\n    .el-checkbox__input .el-checkbox__inner {\n      width: 20px;\n      height: 20px;\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      border-radius: 3px;\n      border: 1px solid #999999;\n      &::after {\n        width: 5px;\n        height: 9px;\n        left: 6px;\n        top: 2px;\n        position: absolute;\n      }\n    }\n    .el-checkbox__input {\n      &.is-checked .el-checkbox__inner {\n        border: 1px solid #ff4a6a;\n      }\n      &.is-disabled .el-checkbox__inner {\n        border: 1px solid #eeeeee;\n        background-color: #eeeeee;\n      }\n    }\n    .el-checkbox__label {\n      min-width: 0;\n      display: flex;\n      align-items: center;\n      .user-avatar {\n        width: 38px;\n        height: 38px;\n        border-radius: 20px;\n        object-fit: contain;\n        margin: 0 10px 0 5px;\n      }\n      .user-name {\n        font-size: 14px;\n        line-height: 22px;\n      }\n    }\n  }\n}\n\n// 穿透 el-dialog style\n#users-dialog :deep(.el-dialog.users-modal) {\n  max-width: 428px;\n  position: relative;\n  border-radius: 6px;\n  box-shadow: 0 0 10px rgb(255 255 255 / 80%);\n  padding: 25px 20px 0;\n  --el-dialog-padding-primary: 10px;\n  .el-dialog__header {\n    padding: 0;\n    .el-dialog__headerbtn .el-icon {\n      --font-size: 20px;\n      font-weight: bold;\n    }\n  }\n  .el-dialog__body {\n    /* padding: 0 calc(var(--el-dialog-padding-primary) + 5px) 20px; */\n    padding: 0 0 20px;\n    .search-user-bar {\n      display: flex;\n      margin: 10px 0 15px;\n      .search-input {\n        flex: 1;\n        border-radius: 6px;\n        background-color: $input-bg-color;\n      }\n      .el-input {\n        line-height: 40px;\n        font-size: 14px;\n        ::placeholder {\n          color: rgba(47, 48, 53, 0.4);\n          font-size: 14px;\n        }\n        .el-input__inner {\n          padding-left: 34px;\n          height: 40px;\n          line-height: 40px;\n          border: none;\n          background-color: $input-bg-color;\n        }\n        .el-input__prefix {\n          left: 9px;\n        }\n        .el-input-group__append {\n          border: none;\n          padding: 0;\n          background-color: $input-bg-color;\n        }\n      }\n    }\n  }\n}\n</style>\n","\nimport { defineComponent, ref, watch, toRefs, computed } from 'vue';\nimport { useStore } from 'vuex';\nimport { ElMessage } from 'element-plus';\nimport { useMutation } from '@vue/apollo-composable';\nimport { exceptionCapture, errorMessage } from '@/utils';\nimport {\n  CREATE_CHAT_MUTATION,\n  ADD_MEMBERS_MUTATION,\n  DELETE_MEMBERS_MUTATION,\n  CHATS_QUERY,\n  CHAT_QUERY,\n  useSearchUsersQuery\n} from '@/graphql';\nimport Skeleton from '../Skeleton.vue';\nimport LoadingSpinner from '../LoadingSpinner.vue';\nimport Empty from '../Empty.vue';\n\nexport default defineComponent({\n  props: {\n    users: {\n      type: Array,\n      default: []\n    },\n    chatId: {\n      type: Number\n    }\n  },\n  components: {\n    Skeleton,\n    LoadingSpinner,\n    Empty\n  },\n  setup(props) {\n    const { users, chatId } = toRefs(props);\n    const store = useStore();\n    const me = ref(store.state?.user?.user);\n    const visible = ref(false);\n    const content = ref('');\n    const keywords = ref('');\n    const operation = ref('');\n    const selectedPerson = ref([]); // 已选中的用户ID\n\n    const isAdd = computed(() => operation.value === 'add');\n    const isGroupChat = computed(() => {\n      return Array.isArray(users.value) && users.value?.length > 2;\n    });\n    const disabledUids = computed(() => {\n      let ids = [];\n      if (isAdd.value && Array.isArray(users.value)) {\n        users.value.filter(user => user?.id && ids.push(user?.id));\n      }\n      return ids;\n    });\n\n    const { loading, searchUsers, refetch, disabled, loadMore, hasMorePages } = useSearchUsersQuery(\n      { keywords },\n      { fetchPolicy: 'network-only' }\n    );\n\n    const onSearch = ({ q }) => {\n      const text = q || content.value || '';\n      content.value = text;\n      keywords.value = text;\n      refetch();\n    };\n\n    const { mutate: createChatMutation, loading: createLoading } = useMutation(CREATE_CHAT_MUTATION, () => ({\n      variables: { uids: selectedPerson.value.concat(disabledUids.value), type: 'GROUP_TYPE' },\n      refetchQueries: () => [\n        {\n          query: CHATS_QUERY,\n          variables: { user_id: me.value?.id }\n        }\n      ]\n    }));\n\n    const { mutate: addMembersMutation, loading: addLoading } = useMutation(ADD_MEMBERS_MUTATION, () => ({\n      variables: {\n        chat_id: chatId.value,\n        uids: selectedPerson.value\n      },\n      refetchQueries: () => [\n        {\n          query: CHATS_QUERY,\n          variables: { user_id: me.value?.id }\n        },\n        {\n          query: CHAT_QUERY,\n          variables: { chat_id: chatId.value }\n        }\n      ]\n    }));\n\n    const { mutate: deleteMembersMutation, loading: deleteLoading } = useMutation(DELETE_MEMBERS_MUTATION, () => ({\n      variables: {\n        chat_id: chatId.value,\n        uids: selectedPerson.value\n      },\n      refetchQueries: () => [\n        {\n          query: CHATS_QUERY,\n          variables: { user_id: me.value?.id }\n        },\n        {\n          query: CHAT_QUERY,\n          variables: { chat_id: chatId.value }\n        }\n      ]\n    }));\n\n    async function onFinish() {\n      const [err, res] = await exceptionCapture(() => {\n        if (isAdd.value) {\n          if (isGroupChat.value) {\n            return addMembersMutation(); // 添加成员\n          } else {\n            return createChatMutation(); // 创建群聊\n          }\n        } else {\n          return deleteMembersMutation(); // 移除成员\n        }\n      });\n      if (err) {\n        ElMessage.error(`操作失败：${errorMessage(err)}`);\n      } else if (res) {\n        visible.value = false;\n        ElMessage({ message: '操作成功', type: 'success' });\n      }\n    }\n\n    return {\n      visible,\n      content,\n      onSearch,\n      isAdd,\n      loading,\n      searchUsers,\n      refetch,\n      disabled,\n      loadMore,\n      hasMorePages,\n      operation,\n      disabledUids,\n      selectedPerson,\n      createLoading,\n      addLoading,\n      deleteLoading,\n      onFinish\n    };\n  },\n  methods: {\n    isDisabled(user_id) {\n      return this.disabledUids.findIndex(id => id === user_id) !== -1;\n    }\n  },\n  mounted() {\n    this.$bus.on('SHOW_USERS_MODAL', (operation: 'add' | 'delete') => {\n      if (operation) {\n        this.operation = operation;\n        this.visible = true;\n        this.selectedPerson = [];\n        this.refetch();\n      }\n    });\n  }\n});\n","import { render } from \"./SelectUsers.vue?vue&type=template&id=36b55556&scoped=true\"\nimport script from \"./SelectUsers.vue?vue&type=script&lang=ts\"\nexport * from \"./SelectUsers.vue?vue&type=script&lang=ts\"\n\nimport \"./SelectUsers.vue?vue&type=style&index=0&id=36b55556&lang=scss&scoped=true\"\nscript.render = render\nscript.__scopeId = \"data-v-36b55556\"\n\nexport default script","\nimport { toRefs, computed, ref } from 'vue';\nimport { useStore } from 'vuex';\nimport { ElMessage } from 'element-plus';\nimport { useMutation } from '@vue/apollo-composable';\nimport { exceptionCapture, errorMessage } from '@/utils';\nimport {\n  UPDATE_CHAT_MUTATION,\n  DELETE_MEMBERS_MUTATION,\n  DELETE_CHAT_MUTATION,\n  CHATS_QUERY,\n  CHAT_QUERY\n} from '@/graphql';\nimport SelectUsers from './SelectUsers.vue';\n\nexport default {\n  props: {\n    chat: Object\n  },\n  components: {\n    SelectUsers\n  },\n  setup(props) {\n    const { chat } = toRefs(props);\n    const store = useStore();\n    const me = ref(store.state?.user?.user);\n    const isGroupChat = computed(() => chat.value?.users?.length > 2);\n    const isGroupOwner = computed(() => me.value?.id && chat.value?.user?.id === me.value?.id);\n    const chatName = computed(() =>\n      isGroupChat.value ? chat.value?.subject || '匿名群聊' : chat.value?.withUser?.name || '聊天消息'\n    );\n\n    const deleteUids = computed(() => {\n      if (isGroupOwner.value) {\n        // 解散群聊的用户ids\n        let users = [];\n        chat.value?.users.map(user => {\n          user?.id && users.push(user?.id);\n        });\n        return users;\n      } else {\n        // 退出群聊的用户id\n        return [me.value?.id];\n      }\n    });\n\n    const groupName = ref('');\n    const editDialogVisible = ref(false);\n    const { mutate: updateChatMutate } = useMutation(UPDATE_CHAT_MUTATION, () => ({\n      variables: {\n        chat_id: chat.value?.id,\n        subject: groupName.value\n      }\n    }));\n\n    const { mutate: deleteMembersMutate } = useMutation(DELETE_MEMBERS_MUTATION, () => ({\n      variables: {\n        chat_id: chat.value?.id,\n        uids: deleteUids.value\n      },\n      refetchQueries: () => [\n        {\n          query: CHATS_QUERY,\n          variables: { user_id: me.value?.id }\n        },\n        {\n          query: CHAT_QUERY,\n          variables: { chat_id: chat.value?.id }\n        }\n      ]\n    }));\n\n    const { mutate: deleteChatMutate } = useMutation(DELETE_CHAT_MUTATION, () => ({\n      variables: { chat_id: chat.value?.id },\n      refetchQueries: () => [\n        {\n          query: CHATS_QUERY,\n          variables: { user_id: me.value?.id }\n        },\n        {\n          query: CHAT_QUERY,\n          variables: { chat_id: chat.value?.id }\n        }\n      ]\n    }));\n\n    async function updateChat() {\n      if (!groupName.value?.length) {\n        ElMessage.error('请输入群聊名称');\n        return;\n      }\n      const [err, res] = await exceptionCapture(() => updateChatMutate());\n      if (err) {\n        ElMessage.error(`修改失败：${errorMessage(err)}`);\n      } else if (res?.data.updateChat) {\n        editDialogVisible.value = false;\n        ElMessage({ message: '修改成功', type: 'success' });\n      }\n    }\n\n    async function deleteGroupChat() {\n      // 是否解散群聊（是群主则解散群聊，否则仅退出群聊）\n      const isDisband = isGroupOwner.value;\n      if (chat.value?.id && deleteUids.value) {\n        const [err, res] = await exceptionCapture(() => (isDisband ? deleteChatMutate() : deleteMembersMutate()));\n        if (err) {\n          ElMessage.error(`退群失败：${errorMessage(err) || (isDisband ? '解散群聊失败！' : '退群失败！')}`);\n        } else if (res?.data?.removeParticipantsInGroupChat) {\n          ElMessage({ message: '你已退出该群！', type: 'success' });\n        } else if (res?.data?.deleteChat) {\n          ElMessage({ message: '已解散群聊！', type: 'success' });\n        }\n      } else {\n        ElMessage.error('群聊信息丢失!');\n      }\n    }\n\n    return {\n      chat,\n      chatName,\n      isGroupChat,\n      isGroupOwner,\n      groupName,\n      editDialogVisible,\n      updateChat,\n      deleteGroupChat\n    };\n  },\n  methods: {\n    toggleVisible() {\n      this.editDialogVisible = !this.editDialogVisible;\n    },\n    showUsersModal(operation: 'add' | 'delete') {\n      if (operation) {\n        this.$bus.emit('SHOW_USERS_MODAL', operation);\n      }\n    }\n  }\n};\n","import { render } from \"./MessagesHeader.vue?vue&type=template&id=4e53a512&scoped=true\"\nimport script from \"./MessagesHeader.vue?vue&type=script&lang=ts\"\nexport * from \"./MessagesHeader.vue?vue&type=script&lang=ts\"\n\nimport \"./MessagesHeader.vue?vue&type=style&index=0&id=4e53a512&lang=scss&scoped=true\"\nscript.render = render\nscript.__scopeId = \"data-v-4e53a512\"\n\nexport default script","<template>\n  <div id=\"message-list\" class=\"message-list\">\n    <template v-if=\"chatId\">\n      <div class=\"msg-center-tips\" @click=\"loadLastPageMessages\">\n        <i v-if=\"loading || loadingMore\" class=\"el-icon-loading\" />\n        <div v-else>{{ hasMorePages ? '加载更多消息' : '没有更多消息了~' }}</div>\n      </div>\n      <div v-if=\"messagesData?.length\">\n        <div v-for=\"(message, index) in messagesData\" :key=\"message?.id\">\n          <MessageItem :message=\"message\" :index=\"index\" :messages-data=\"messagesData\" v-bind=\"$attrs\" />\n        </div>\n      </div>\n    </template>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { toRefs, ref, watch } from 'vue';\nimport { useChatMessagesQuery } from '@/graphql';\nimport MessageItem from './MessageItem.vue';\n\nexport default {\n  name: 'MessagesView',\n  props: {\n    chatId: Number\n  },\n  components: {\n    MessageItem\n  },\n  setup(props) {\n    const { chatId } = toRefs(props);\n\n    const {\n      messages,\n      refetch,\n      loading,\n      currentPage,\n      hasMorePages,\n      disabled,\n      loadMore,\n      loadingMore\n    } = useChatMessagesQuery({ chat_id: chatId }, { enabled: !!chatId.value });\n    const messagesData = ref(messages.value);\n\n    function loadLastPageMessages() {\n      if (!disabled.value) {\n        loadMore();\n      }\n    }\n\n    const scrollHeight = ref(0);\n    function scrollToPosition(position?: 'bottom' | 'normal') {\n      let ele = document.getElementById('message-list');\n      setTimeout(() => {\n        if (position === 'bottom') {\n          // 设置滚动条到最底部\n          if (ele.scrollHeight > ele.clientHeight) {\n            ele.scrollTop = ele.scrollHeight;\n          }\n        } else {\n          // 滚动到当前浏览位置\n          if (ele.scrollHeight > ele.clientHeight && scrollHeight.value > 0) {\n            ele.scrollTop = Number(ele.scrollHeight - scrollHeight.value);\n          }\n        }\n        scrollHeight.value = ele.scrollHeight;\n      }, 0);\n    }\n\n    function appendMessageObj(msgObj) {\n      if (Object.prototype.toString.call(msgObj) === '[object Object]') {\n        messagesData.value = messagesData.value.concat(msgObj);\n      }\n      scrollToPosition('bottom');\n    }\n\n    watch(messages, () => {\n      messagesData.value = messages.value;\n      if (currentPage.value == 1) {\n        scrollToPosition('bottom');\n      } else {\n        scrollToPosition();\n      }\n      console.log('messagesData', messagesData.value);\n    });\n\n    return {\n      chatId,\n      messagesData,\n      loading,\n      loadingMore,\n      hasMorePages,\n      loadLastPageMessages,\n      appendMessageObj // 给外部组件调用\n    };\n  }\n};\n</script>\n\n<style lang=\"scss\" scoped>\n::-webkit-scrollbar-track {\n  background-color: transparent;\n}\n.message-list {\n  flex: 1;\n  position: relative;\n  overflow-x: hidden;\n  overflow-y: scroll;\n  background-color: #f4f5f7;\n  .msg-center-tips {\n    color: #999;\n    font-size: 14px;\n    line-height: 1.5;\n    padding: 16px 0 0;\n    text-align: center;\n    min-height: 38px;\n    .el-icon-loading {\n      color: #999;\n      font-size: 20px;\n    }\n  }\n}\n</style>\n","<template>\n  <div>\n    <div class=\"msg-date msg-date\" v-if=\"date\">\n      {{ date }}\n    </div>\n    <div :class=\"['message-item', isSelf(message?.user?.id) && 'message-item-right']\">\n      <img v-if=\"!isSelf(message?.user?.id)\" :src=\"message?.user?.avatar\" alt=\"avatar\" class=\"msg-user-avatar\" />\n      <div class=\"message-wrap\">\n        <div class=\"msg-user-name\">{{ message?.user?.name }}</div>\n        <div class=\"flex-row-align-center msg-content\">\n          <div v-if=\"isSelf(message?.user?.id)\" :class=\"['send-status', 'right']\">\n            <i v-if=\"messageStatus.loading\" class=\"el-icon-loading\" />\n            <i v-else-if=\"messageStatus.error\" class=\"el-icon-warning send-error-icon\" />\n          </div>\n          <div class=\"message-box msg-text-box\" v-if=\"message?.type === 'text'\">\n            <span v-html=\"parsingEmoji(message?.message)\"></span>\n          </div>\n          <div class=\"message-box msg-image-box\" v-else-if=\"message?.type === 'image'\">\n            <img v-lazyload=\"message?.body?.url\" alt=\"图片\" class=\"msg-img\" />\n          </div>\n          <div v-if=\"!isSelf(message?.user?.id)\" :class=\"['send-status', 'left']\">\n            <i v-if=\"messageStatus.loading\" class=\"el-icon-loading\" />\n            <i v-else-if=\"messageStatus.error\" class=\"el-icon-warning send-error-icon\" />\n          </div>\n        </div>\n      </div>\n      <img v-if=\"isSelf(message?.user?.id)\" :src=\"message?.user?.avatar\" alt=\"avatar\" class=\"msg-user-avatar\" />\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { computed, ref, toRefs, onMounted } from 'vue';\nimport { useStore } from 'vuex';\nimport { ElMessage } from 'element-plus';\nimport { parsingEmoji } from 'vemoji-list';\nimport { useMutation } from '@vue/apollo-composable';\nimport { exceptionCapture, errorMessage } from '@/utils';\nimport { SEND_MESSAGE_MUTATION, CHATS_QUERY } from '@/graphql';\nimport moment from '@/utils/moment';\n\nexport default {\n  props: {\n    message: Object,\n    index: Number,\n    messagesData: {\n      type: Array,\n      default: []\n    }\n  },\n  setup(props, context) {\n    const { message, index, messagesData } = toRefs(props);\n    const store = useStore();\n    const me = ref(store.state?.user?.user);\n    const isSelf = (userId: number) => (userId ? userId === me.value?.id : false);\n\n    const date = computed(() =>\n      moment.messageDateStr(message.value?.created_at, messagesData.value?.[index.value - 1]?.created_at || '')\n    );\n\n    const { mutate: sendMessageMutate } = useMutation(SEND_MESSAGE_MUTATION, () => ({\n      variables: { ...message.value?.payload },\n      refetchQueries: () => [\n        {\n          query: CHATS_QUERY,\n          variables: { user_id: me.value?.id }\n        }\n      ]\n    }));\n\n    // 发送消息\n    const messageStatus = ref({ loading: false, error: '' });\n    async function sendMessage() {\n      if (message.value?.payload) {\n        messageStatus.value.loading = true;\n        const [err, res] = await exceptionCapture(() => sendMessageMutate());\n        if (err) {\n          messageStatus.value = { loading: false, error: err };\n          ElMessage.error(`Error：${errorMessage(err)}`);\n        } else if (res?.data?.sendMessage) {\n          messageStatus.value = { loading: false, error: '' };\n          context.emit('sendSuccess'); // 消息发送成功清空输入框内容\n          console.log('发送成功', res?.data?.sendMessage);\n        }\n      }\n    }\n\n    onMounted(() => {\n      sendMessage();\n    });\n\n    return { message, index, messageStatus, messagesData, date, isSelf };\n  },\n  data() {\n    return { parsingEmoji };\n  }\n};\n</script>\n\n<style lang=\"scss\" scoped>\n.el-icon-loading {\n  color: #999;\n  font-size: 18px;\n  &.large-size {\n    font-size: 20px;\n  }\n}\n.msg-date {\n  color: #999;\n  font-size: 14px;\n  line-height: 1.5;\n  padding: 16px 0 0;\n  text-align: center;\n  min-height: 38px;\n  &.msg-date {\n    padding: 20px 0;\n  }\n}\n.message-item {\n  flex: 1;\n  display: flex;\n  flex-direction: row;\n  justify-content: flex-start;\n  min-height: 48px;\n  padding: 0 16px 24px;\n  overflow: hidden;\n  position: relative;\n  .flex-row-align-center {\n    flex: 1;\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n  }\n  .msg-user-avatar {\n    width: 42px;\n    height: 42px;\n    border-radius: 50%;\n    background-color: #eeeeee;\n  }\n  .message-wrap {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    align-items: flex-start;\n    .msg-user-name {\n      max-width: 30%;\n      color: #999;\n      font-size: 12px;\n      line-height: 1.5;\n      margin: 0 10px 6px;\n    }\n    .msg-content {\n      width: 100%;\n      .message-box {\n        max-width: 86%;\n        margin: 0 10px;\n        overflow: hidden;\n        background-color: #fff;\n      }\n      .msg-text-box {\n        font-size: 14px;\n        line-height: 1.5;\n        min-height: 37px;\n        word-wrap: break-word;\n        word-break: break-word;\n        padding: 8px 16px;\n      }\n      .msg-image-box {\n        .msg-img {\n          width: 100px;\n          height: auto;\n          background-color: #ffffff;\n        }\n      }\n      .msg-image-box,\n      .msg-text-box {\n        border-radius: 0 16px 16px 16px;\n      }\n      .send-status {\n        flex: 1;\n        display: flex;\n        flex-direction: row;\n        align-items: center;\n        &.left {\n          justify-content: flex-start;\n        }\n        &.right {\n          justify-content: flex-end;\n        }\n        .send-error-icon {\n          color: #dd001c;\n        }\n      }\n    }\n  }\n  &.message-item-right {\n    justify-content: flex-end;\n    .message-wrap {\n      display: flex;\n      flex-direction: column;\n      align-items: flex-end;\n      .msg-user-name {\n        text-align: right;\n      }\n      .msg-text-box,\n      .msg-image-box {\n        border-radius: 16px 0 16px 16px;\n      }\n    }\n  }\n}\n@import '@/scss/views/chat-page.scss';\n</style>\n","\nimport { computed, ref, toRefs, onMounted } from 'vue';\nimport { useStore } from 'vuex';\nimport { ElMessage } from 'element-plus';\nimport { parsingEmoji } from 'vemoji-list';\nimport { useMutation } from '@vue/apollo-composable';\nimport { exceptionCapture, errorMessage } from '@/utils';\nimport { SEND_MESSAGE_MUTATION, CHATS_QUERY } from '@/graphql';\nimport moment from '@/utils/moment';\n\nexport default {\n  props: {\n    message: Object,\n    index: Number,\n    messagesData: {\n      type: Array,\n      default: []\n    }\n  },\n  setup(props, context) {\n    const { message, index, messagesData } = toRefs(props);\n    const store = useStore();\n    const me = ref(store.state?.user?.user);\n    const isSelf = (userId: number) => (userId ? userId === me.value?.id : false);\n\n    const date = computed(() =>\n      moment.messageDateStr(message.value?.created_at, messagesData.value?.[index.value - 1]?.created_at || '')\n    );\n\n    const { mutate: sendMessageMutate } = useMutation(SEND_MESSAGE_MUTATION, () => ({\n      variables: { ...message.value?.payload },\n      refetchQueries: () => [\n        {\n          query: CHATS_QUERY,\n          variables: { user_id: me.value?.id }\n        }\n      ]\n    }));\n\n    // 发送消息\n    const messageStatus = ref({ loading: false, error: '' });\n    async function sendMessage() {\n      if (message.value?.payload) {\n        messageStatus.value.loading = true;\n        const [err, res] = await exceptionCapture(() => sendMessageMutate());\n        if (err) {\n          messageStatus.value = { loading: false, error: err };\n          ElMessage.error(`Error：${errorMessage(err)}`);\n        } else if (res?.data?.sendMessage) {\n          messageStatus.value = { loading: false, error: '' };\n          context.emit('sendSuccess'); // 消息发送成功清空输入框内容\n          console.log('发送成功', res?.data?.sendMessage);\n        }\n      }\n    }\n\n    onMounted(() => {\n      sendMessage();\n    });\n\n    return { message, index, messageStatus, messagesData, date, isSelf };\n  },\n  data() {\n    return { parsingEmoji };\n  }\n};\n","import { render } from \"./MessageItem.vue?vue&type=template&id=c8530324&scoped=true\"\nimport script from \"./MessageItem.vue?vue&type=script&lang=ts\"\nexport * from \"./MessageItem.vue?vue&type=script&lang=ts\"\n\nimport \"./MessageItem.vue?vue&type=style&index=0&id=c8530324&lang=scss&scoped=true\"\nscript.render = render\nscript.__scopeId = \"data-v-c8530324\"\n\nexport default script","\nimport { toRefs, ref, watch } from 'vue';\nimport { useChatMessagesQuery } from '@/graphql';\nimport MessageItem from './MessageItem.vue';\n\nexport default {\n  name: 'MessagesView',\n  props: {\n    chatId: Number\n  },\n  components: {\n    MessageItem\n  },\n  setup(props) {\n    const { chatId } = toRefs(props);\n\n    const {\n      messages,\n      refetch,\n      loading,\n      currentPage,\n      hasMorePages,\n      disabled,\n      loadMore,\n      loadingMore\n    } = useChatMessagesQuery({ chat_id: chatId }, { enabled: !!chatId.value });\n    const messagesData = ref(messages.value);\n\n    function loadLastPageMessages() {\n      if (!disabled.value) {\n        loadMore();\n      }\n    }\n\n    const scrollHeight = ref(0);\n    function scrollToPosition(position?: 'bottom' | 'normal') {\n      let ele = document.getElementById('message-list');\n      setTimeout(() => {\n        if (position === 'bottom') {\n          // 设置滚动条到最底部\n          if (ele.scrollHeight > ele.clientHeight) {\n            ele.scrollTop = ele.scrollHeight;\n          }\n        } else {\n          // 滚动到当前浏览位置\n          if (ele.scrollHeight > ele.clientHeight && scrollHeight.value > 0) {\n            ele.scrollTop = Number(ele.scrollHeight - scrollHeight.value);\n          }\n        }\n        scrollHeight.value = ele.scrollHeight;\n      }, 0);\n    }\n\n    function appendMessageObj(msgObj) {\n      if (Object.prototype.toString.call(msgObj) === '[object Object]') {\n        messagesData.value = messagesData.value.concat(msgObj);\n      }\n      scrollToPosition('bottom');\n    }\n\n    watch(messages, () => {\n      messagesData.value = messages.value;\n      if (currentPage.value == 1) {\n        scrollToPosition('bottom');\n      } else {\n        scrollToPosition();\n      }\n      console.log('messagesData', messagesData.value);\n    });\n\n    return {\n      chatId,\n      messagesData,\n      loading,\n      loadingMore,\n      hasMorePages,\n      loadLastPageMessages,\n      appendMessageObj // 给外部组件调用\n    };\n  }\n};\n","import { render } from \"./MessagesView.vue?vue&type=template&id=3f1099a6&scoped=true\"\nimport script from \"./MessagesView.vue?vue&type=script&lang=ts\"\nexport * from \"./MessagesView.vue?vue&type=script&lang=ts\"\n\nimport \"./MessagesView.vue?vue&type=style&index=0&id=3f1099a6&lang=scss&scoped=true\"\nscript.render = render\nscript.__scopeId = \"data-v-3f1099a6\"\n\nexport default script","<template>\n  <div class=\"send-section\">\n    <div class=\"operation-row\">\n      <el-upload\n        class=\"uploader\"\n        action=\"#\"\n        type=\"file\"\n        accept=\"image/png, image/jpeg, image/jpg, image/gif\"\n        :before-upload=\"onBeforeUpload\"\n      >\n        <label class=\"image-upload-btn\"></label>\n      </el-upload>\n      <el-popover popper-class=\"emoji-popover\" placement=\"top\" :width=\"360\" trigger=\"hover\">\n        <template #reference>\n          <label class=\"emotion-btn-box\"></label>\n        </template>\n        <div class=\"emoji-list-wrap\">\n          <span v-for=\"emoji in emojiList\" :key=\"emoji?.url\" @click=\"insetEmoji(emoji?.title)\">\n            <span v-html=\"parsingEmoji(`[${emoji?.title}]`)\"></span>\n          </span>\n        </div>\n      </el-popover>\n    </div>\n    <div class=\"send-input\">\n      <el-input type=\"textarea\" id=\"textarea\" v-model=\"content\" clearable maxlength=\"300\" />\n    </div>\n    <div class=\"flex-end-send-btn\">\n      <div class=\"indicator\">{{ content?.length || 0 }}/300</div>\n      <button :class=\"['send-button', content && 'active']\" :disabled=\"!content\" @click=\"sendPayloadMessage('text')\">\n        <span class=\"btn-title\">发送</span>\n      </button>\n    </div>\n  </div>\n</template>\n\n<script lang=\"ts\">\nimport { toRefs, ref, nextTick } from 'vue';\nimport { useStore } from 'vuex';\nimport { ElMessage } from 'element-plus';\nimport { emojiList, parsingEmoji } from 'vemoji-list';\n\nconst messageObj = {\n  __typename: 'Message',\n  body: {\n    __typename: 'MessageBody',\n    text: '',\n    url: null\n  },\n  created_at: '',\n  id: 1,\n  message: '',\n  messageable: null,\n  messageable_id: null,\n  messageable_type: null,\n  time_ago: '1秒前',\n  type: 'text',\n  user: {}\n};\n\nexport default {\n  name: 'SendSection',\n  props: {\n    chatId: Number\n  },\n  setup(props, context) {\n    const { chatId } = toRefs(props);\n    const store = useStore();\n    const me = ref(store.state?.user?.user);\n\n    const content = ref(''); // 消息内容\n    const imageUrl = ref(''); // 图片url\n    const messagesViewRef = ref(null);\n    function payloadMessage(isTextMessage) {\n      let incomingMessage = {\n        ...messageObj,\n        id: new Date().getTime(),\n        user: { ...me.value },\n        created_at: new Date(),\n        payload: null\n      };\n\n      if (isTextMessage) {\n        incomingMessage.type = 'text';\n        incomingMessage.message = content.value;\n        incomingMessage.body.text = content.value;\n        incomingMessage.payload = {\n          user_id: me.value?.id,\n          chat_id: chatId.value,\n          message: content.value,\n          url: ''\n        };\n      } else {\n        incomingMessage.type = 'image';\n        incomingMessage.message = '';\n        incomingMessage.body.url = imageUrl.value;\n        incomingMessage.payload = {\n          user_id: me.value?.id,\n          chat_id: chatId.value,\n          url: imageUrl.value,\n          message: ''\n        };\n      }\n\n      // 追加 incomingMessage 数据到消息列表，并滚动到消息列表底部\n      context.emit('appendMessage', incomingMessage);\n    }\n\n    // 目前仅实现文本消息和图片消息\n    function sendPayloadMessage(messageType: 'text' | 'image') {\n      let isTextMessage = messageType !== 'image';\n      console.log('messageType', isTextMessage, messageType, content.value, imageUrl.value);\n      if ((isTextMessage && !content.value) || (!isTextMessage && !imageUrl.value)) {\n        ElMessage.error('消息内容不能为空或者您还未选中图片！');\n        return;\n      }\n\n      // 预先渲染消息\n      payloadMessage(isTextMessage);\n    }\n\n    // 消息发送成功时调用\n    function sendSuccess() {\n      content.value = '';\n      imageUrl.value = '';\n    }\n\n    // 插入表情包\n    async function insetEmoji(emojiTitle) {\n      const inner = '[' + (emojiTitle || '') + ']';\n      const inputElement: any = document.querySelector('#textarea');\n      if (inputElement.selectionStart || inputElement.selectionStart === 0) {\n        // 获取光标起始位置\n        let startPos = inputElement.selectionStart;\n        let endPos = inputElement.selectionEnd;\n        let inputValue = inputElement.value;\n        console.log('startPos,endPos', startPos, endPos);\n        content.value = inputValue.substring(0, startPos) + inner + inputValue.substring(endPos, inputValue.length);\n        await nextTick(); // 重点\n        inputElement.focus();\n        inputElement.setSelectionRange(endPos + inner.length, endPos + inner.length);\n      } else {\n        content.value = inner;\n      }\n    }\n\n    return {\n      content,\n      imageUrl,\n      sendPayloadMessage,\n      messagesViewRef,\n      sendSuccess, // 给外部调用\n      insetEmoji\n    };\n  },\n  methods: {\n    onBeforeUpload(file) {\n      if (file) {\n        var reader = new FileReader();\n        reader.readAsDataURL(file);\n        reader.onload = e => {\n          this.imageUrl = e.target.result;\n          console.log('this.imageUrl', this.imageUrl);\n          // TODO:imageUrl 为base64格式，先将图片上传到服务器，再发送图片消息\n          // this.sendPayloadMessage('image');\n        };\n      }\n    }\n  },\n  data() {\n    return { emojiList, parsingEmoji };\n  }\n};\n</script>\n\n<style lang=\"scss\" scoped>\n.send-section {\n  width: 100%;\n  height: 100%;\n  padding: 0 16px 5px;\n  .send-input {\n    border-radius: 8px;\n    overflow: hidden;\n    height: calc(100% - 48px - 46px);\n    :deep(.el-textarea) {\n      height: 100%;\n      .el-textarea__inner {\n        height: 100%;\n        border: none;\n        color: #222;\n        font-size: 14px;\n        letter-spacing: 1px;\n        white-space: pre-wrap;\n        padding: 5px 8px 5px 3px;\n        background-color: transparent;\n        word-break: break-word;\n        word-wrap: break-word;\n      }\n    }\n  }\n}\n.send-section .operation-row {\n  display: flex;\n  flex-direction: row;\n  justify-content: flex-start;\n  align-items: center;\n  height: 48px;\n  .uploader {\n    width: 22px;\n    height: 21px;\n    margin-right: 16px;\n  }\n  .image-upload-btn {\n    display: block;\n    width: 22px;\n    height: 21px;\n    cursor: pointer;\n    background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAVCAYAAABCIB6VAAAAAXNSR0IArs4c6QAAAjFJREFUOBG1lUtrU0EUgHMfSX5AkEINSOmii4JuigihFERpoIgrsykEal6bLgQ34h8oXZUiCnlgaRZSshErhZQWAn24sEUFoSRIQQlEEZJNaRpoHn7n0gupN2mTWx04mTkz53znzJm5E8Vx1pLJ5P1mszmpKMqgOddP32q1SqqqrkcikQ3xU+UnHo8vAs0CHRPdThNfYQhL/JVEInGPaOuapk2Fw+GsHajpk0ql/I1GY43M/SpQP9G2rwoVuDCEJSVVGUhNS2ZU6YnsQx4Q1ChV+1oP45IwLY6UJsB2dpBVDnSuB1BHEwuYLNsPsH3cEdBt0gLGMI4cIL8Q2xnrOJ9rsVjskInRc5M2lE4Z28BYXf4b2FIKa2zrDLdlgFszyUHfZPUU+ezxeN4HAoET07ovcC6X0wuFwvN6vf4MwE/kI3dWo58pl8uvuKqP+wYLNJ/Pr+B4m0/2EYe8ZkIymYxWqVRm2UWGta8E+yZvxRsx8Hq9M8Vi8Snbm0YdQRrIF2TZ7Xa/rtVq84wfOp3OCT7dH4wtjQdoCv93LGwZYBQducHENfp5HqRPRHeh+5BZMpDaDZGNLxqN7jHu2oB/YPHUqDGPxh2U3y6X61YoFDpq89pNp9Mvq9XqAvCly6Dih9136XWg0l9ni3f/gsq8IxgMHtNFDaW3n0F2va/quv6WLToIMNybX3creY+BjpN1VhGzs1dfarmNWurueuGKZCrQF5TsiQEW83/xnyeZAt0U3h+pCu2ZMB0nRQAAAABJRU5ErkJggg==)\n      no-repeat;\n    background-size: 22px;\n  }\n  .emotion-btn-box {\n    display: block;\n    width: 24px;\n    height: 24px;\n    cursor: pointer;\n    background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAB5UlEQVR4AWIYMDBz5kzH2bNnOxGhzmbOnDnWJFswa9asSYDWygCigSgO41YAJQAoWSMgAIQASQoUQJbEZAGM0aRERQAEuAFgAkIpAVXDUAzAKLBEQWptcf0+Hp6zd3fPGp+z//u+7/9/9+67Q/wWBMGoi1Or1UbgvMI99W5QrVYnEHfYxV7M9LvisIPJ1MaaCtMVpiojvpcBOAb7EajWgfcgrjTSxppD2kT0jqANrsEleKZ2wfXchmrgRRzDbUsrD9c9L4FPCBthGA753lJppJWHvKLm03Tvcl0c9OmTB149edqHdULh6r8ecXnJ0y7cgLJ9FvwvehgW7XsvL3nahAaEgtVgntoHOGOSMZex1sQRVxpLX5Cns4HJwZTqoAUWouaqmbWGuKp5NdCPFK8y5Rfr9T4N6loTR/+9Guj1QC0wQSr1e2xV05rhBNKkbsD/I4SPYCbpgMWB/8T1MHUDIj/MhBmPkGWk8T4DQ55TCEFoA82P4zXt1wCzHOu/Mo2ghyabtoGSV4kJ0pYMLfOuguXiy0ueduGAwm3CYeYw3TapzSYk+06e9pbGKX5zXRv0PSQP5UOe0QnXdXAs7CR+ONyfz4rxyLu2tgxaJjxN0EiJpjRGu5T44SCVs5oCFFIiL02/xP8BToUvO6m2Rg4AAAAASUVORK5CYII=)\n      no-repeat;\n  }\n}\n.send-section .flex-end-send-btn {\n  display: flex;\n  flex-direction: row;\n  justify-content: flex-end;\n  align-items: center;\n  height: 46px;\n  .indicator {\n    color: #c0c0c0;\n    font-size: 14px;\n    line-height: 30px;\n  }\n  .send-button {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    width: 84px;\n    height: 30px;\n    border-radius: 4px;\n    margin-left: 15px;\n    border: 1px solid #e7e7e7;\n    cursor: pointer;\n    background-color: #ffffff;\n    .btn-title {\n      color: rgba(47, 48, 53, 0.9);\n      font-size: 14px;\n      font-weight: 500;\n      line-height: 22px;\n    }\n    &.active {\n      background-color: $theme-color_primary;\n      .btn-title {\n        color: #ffffff;\n      }\n    }\n  }\n}\n</style>\n<style lang=\"scss\">\n.emoji-popover {\n  &.el-popover.el-popper {\n    max-width: 94%;\n    padding-right: 0;\n  }\n  .emoji-list-wrap {\n    flex: 1;\n    max-height: 200px;\n    position: relative;\n    overflow-x: hidden;\n    overflow-y: scroll;\n  }\n  ::-webkit-scrollbar-track {\n    background-color: transparent;\n  }\n}\n</style>\n","\nimport { toRefs, ref, nextTick } from 'vue';\nimport { useStore } from 'vuex';\nimport { ElMessage } from 'element-plus';\nimport { emojiList, parsingEmoji } from 'vemoji-list';\n\nconst messageObj = {\n  __typename: 'Message',\n  body: {\n    __typename: 'MessageBody',\n    text: '',\n    url: null\n  },\n  created_at: '',\n  id: 1,\n  message: '',\n  messageable: null,\n  messageable_id: null,\n  messageable_type: null,\n  time_ago: '1秒前',\n  type: 'text',\n  user: {}\n};\n\nexport default {\n  name: 'SendSection',\n  props: {\n    chatId: Number\n  },\n  setup(props, context) {\n    const { chatId } = toRefs(props);\n    const store = useStore();\n    const me = ref(store.state?.user?.user);\n\n    const content = ref(''); // 消息内容\n    const imageUrl = ref(''); // 图片url\n    const messagesViewRef = ref(null);\n    function payloadMessage(isTextMessage) {\n      let incomingMessage = {\n        ...messageObj,\n        id: new Date().getTime(),\n        user: { ...me.value },\n        created_at: new Date(),\n        payload: null\n      };\n\n      if (isTextMessage) {\n        incomingMessage.type = 'text';\n        incomingMessage.message = content.value;\n        incomingMessage.body.text = content.value;\n        incomingMessage.payload = {\n          user_id: me.value?.id,\n          chat_id: chatId.value,\n          message: content.value,\n          url: ''\n        };\n      } else {\n        incomingMessage.type = 'image';\n        incomingMessage.message = '';\n        incomingMessage.body.url = imageUrl.value;\n        incomingMessage.payload = {\n          user_id: me.value?.id,\n          chat_id: chatId.value,\n          url: imageUrl.value,\n          message: ''\n        };\n      }\n\n      // 追加 incomingMessage 数据到消息列表，并滚动到消息列表底部\n      context.emit('appendMessage', incomingMessage);\n    }\n\n    // 目前仅实现文本消息和图片消息\n    function sendPayloadMessage(messageType: 'text' | 'image') {\n      let isTextMessage = messageType !== 'image';\n      console.log('messageType', isTextMessage, messageType, content.value, imageUrl.value);\n      if ((isTextMessage && !content.value) || (!isTextMessage && !imageUrl.value)) {\n        ElMessage.error('消息内容不能为空或者您还未选中图片！');\n        return;\n      }\n\n      // 预先渲染消息\n      payloadMessage(isTextMessage);\n    }\n\n    // 消息发送成功时调用\n    function sendSuccess() {\n      content.value = '';\n      imageUrl.value = '';\n    }\n\n    // 插入表情包\n    async function insetEmoji(emojiTitle) {\n      const inner = '[' + (emojiTitle || '') + ']';\n      const inputElement: any = document.querySelector('#textarea');\n      if (inputElement.selectionStart || inputElement.selectionStart === 0) {\n        // 获取光标起始位置\n        let startPos = inputElement.selectionStart;\n        let endPos = inputElement.selectionEnd;\n        let inputValue = inputElement.value;\n        console.log('startPos,endPos', startPos, endPos);\n        content.value = inputValue.substring(0, startPos) + inner + inputValue.substring(endPos, inputValue.length);\n        await nextTick(); // 重点\n        inputElement.focus();\n        inputElement.setSelectionRange(endPos + inner.length, endPos + inner.length);\n      } else {\n        content.value = inner;\n      }\n    }\n\n    return {\n      content,\n      imageUrl,\n      sendPayloadMessage,\n      messagesViewRef,\n      sendSuccess, // 给外部调用\n      insetEmoji\n    };\n  },\n  methods: {\n    onBeforeUpload(file) {\n      if (file) {\n        var reader = new FileReader();\n        reader.readAsDataURL(file);\n        reader.onload = e => {\n          this.imageUrl = e.target.result;\n          console.log('this.imageUrl', this.imageUrl);\n          // TODO:imageUrl 为base64格式，先将图片上传到服务器，再发送图片消息\n          // this.sendPayloadMessage('image');\n        };\n      }\n    }\n  },\n  data() {\n    return { emojiList, parsingEmoji };\n  }\n};\n","import { render } from \"./SendSection.vue?vue&type=template&id=76687f00&scoped=true\"\nimport script from \"./SendSection.vue?vue&type=script&lang=ts\"\nexport * from \"./SendSection.vue?vue&type=script&lang=ts\"\n\nimport \"./SendSection.vue?vue&type=style&index=0&id=76687f00&lang=scss&scoped=true\"\nimport \"./SendSection.vue?vue&type=style&index=1&id=76687f00&lang=scss\"\nscript.render = render\nscript.__scopeId = \"data-v-76687f00\"\n\nexport default script","\nimport { ref, watch, onMounted } from 'vue';\nimport { useStore } from 'vuex';\nimport { useRoute, useRouter } from 'vue-router';\nimport { ElMessage } from 'element-plus';\nimport { useMutation, useQuery } from '@vue/apollo-composable';\nimport { CREATE_CHAT_MUTATION, CHAT_QUERY, CHATS_QUERY } from '@/graphql';\nimport { exceptionCapture, errorMessage } from '@/utils';\nimport ChatsList from '@/components/chat/ChatsList.vue';\nimport MessagesHeader from '@/components/chat/MessagesHeader.vue';\nimport MessagesView from '@/components/chat/MessagesView.vue';\nimport SendSection from '@/components/chat/SendSection.vue';\n\nexport default {\n  components: {\n    ChatsList,\n    MessagesHeader,\n    MessagesView,\n    SendSection\n  },\n  setup() {\n    const route = useRoute();\n    const router = useRouter();\n    const store = useStore();\n    const me = ref(store.state?.user?.user);\n\n    const chatId = ref(Number(route?.query?.chat_id));\n    const userId = ref(Number(route?.query?.user_id));\n    const uids = ref([me.value?.id, userId.value]);\n    const chat = ref({ id: chatId.value });\n\n    function showMessageView(currentChat) {\n      if (currentChat?.id) {\n        chatId.value = currentChat?.id;\n        chat.value = currentChat;\n      }\n    }\n\n    const { result } = useQuery(CHAT_QUERY, { chat_id: chatId.value }, { enabled: !!chatId.value });\n    watch(result, () => {\n      const chatResult = result.value?.chat;\n      showMessageView(chatResult);\n    });\n\n    const { mutate: createChatMutation, loading: createLoading } = useMutation(CREATE_CHAT_MUTATION, () => ({\n      variables: { uids: uids.value },\n      refetchQueries: () => [\n        {\n          query: CHATS_QUERY,\n          variables: { user_id: me.value?.id }\n        }\n      ]\n    }));\n\n    const messagesViewRef = ref(null);\n    const sendSectionRef = ref(null);\n\n    function appendIncomingMessage(incomingMessage) {\n      // appendMessageObj：消息列表组件中的函数。用于追加 incomingMessage 对象到消息列表，并滚动到消息列表底部\n      const appendMessage = messagesViewRef.value?.appendMessageObj;\n      if (incomingMessage && Object.prototype.toString.call(appendMessage) === '[object Function]') {\n        appendMessage(incomingMessage);\n      }\n    }\n\n    function sendSuccess() {\n      // sendSuccess：发送框组件中的函数。用于消息发送成功后清空输入框的内容\n      const onSendSuccess = sendSectionRef.value?.sendSuccess;\n      if (Object.prototype.toString.call(onSendSuccess) === '[object Function]') {\n        onSendSuccess();\n      }\n    }\n\n    onMounted(async () => {\n      const isNeedCreate = !chatId.value && me.value?.id && userId.value;\n      const LegalUids = Array.isArray(uids.value) && uids.value?.length > 1;\n      if (isNeedCreate && LegalUids) {\n        console.log('创建聊天');\n        const [err, res] = await exceptionCapture(() => createChatMutation());\n        if (err) {\n          ElMessage.error(`创建聊天失败：${errorMessage(err)}`);\n        } else if (res?.data.createChat) {\n          showMessageView(res?.data.createChat);\n        }\n      }\n    });\n\n    watch(chatId, () => {\n      router.replace({ query: { chat_id: Number(chatId.value) } });\n    });\n\n    return {\n      chat,\n      chatId,\n      createLoading,\n      showMessageView,\n      messagesViewRef,\n      sendSectionRef,\n      appendIncomingMessage,\n      sendSuccess\n    };\n  },\n  computed: {\n    isMobile() {\n      const uaInfo = navigator.userAgent.match(\n        /(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i\n      );\n      console.log('mobile', !!uaInfo);\n      return !!uaInfo;\n    }\n  }\n};\n","import { render } from \"./ChatPage.vue?vue&type=template&id=59efcbbc&scoped=true\"\nimport script from \"./ChatPage.vue?vue&type=script&lang=ts\"\nexport * from \"./ChatPage.vue?vue&type=script&lang=ts\"\n\nimport \"./ChatPage.vue?vue&type=style&index=0&id=59efcbbc&lang=scss&scoped=true\"\nscript.render = render\nscript.__scopeId = \"data-v-59efcbbc\"\n\nexport default script","export * from \"-!../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../node_modules/vue-loader-v16/dist/stylePostLoader.js!../../../node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-2!../../../node_modules/sass-loader/dist/cjs.js??ref--8-oneOf-1-3!../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../node_modules/vue-loader/dist/index.js??ref--0-1!./MessagesView.vue?vue&type=style&index=0&id=3f1099a6&lang=scss&scoped=true\"","export * from \"-!../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../node_modules/vue-loader-v16/dist/stylePostLoader.js!../../../node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-2!../../../node_modules/sass-loader/dist/cjs.js??ref--8-oneOf-1-3!../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../node_modules/vue-loader/dist/index.js??ref--0-1!./SendSection.vue?vue&type=style&index=1&id=76687f00&lang=scss\"","export * from \"-!../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../node_modules/vue-loader-v16/dist/stylePostLoader.js!../../../node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-2!../../../node_modules/sass-loader/dist/cjs.js??ref--8-oneOf-1-3!../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../node_modules/vue-loader/dist/index.js??ref--0-1!./SendSection.vue?vue&type=style&index=0&id=76687f00&lang=scss&scoped=true\"","export * from \"-!../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../node_modules/vue-loader-v16/dist/stylePostLoader.js!../../node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-2!../../node_modules/sass-loader/dist/cjs.js??ref--8-oneOf-1-3!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader/dist/index.js??ref--0-1!./ChatPage.vue?vue&type=style&index=0&id=59efcbbc&lang=scss&scoped=true\"","export * from \"-!../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../node_modules/vue-loader-v16/dist/stylePostLoader.js!../../../node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-2!../../../node_modules/sass-loader/dist/cjs.js??ref--8-oneOf-1-3!../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../node_modules/vue-loader/dist/index.js??ref--0-1!./SelectUsers.vue?vue&type=style&index=0&id=36b55556&lang=scss&scoped=true\"","export * from \"-!../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../node_modules/vue-loader-v16/dist/stylePostLoader.js!../../../node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-2!../../../node_modules/sass-loader/dist/cjs.js??ref--8-oneOf-1-3!../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../node_modules/vue-loader/dist/index.js??ref--0-1!./ChatsList.vue?vue&type=style&index=0&id=091678a4&lang=scss&scoped=true\"","export * from \"-!../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../node_modules/vue-loader-v16/dist/stylePostLoader.js!../../../node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-2!../../../node_modules/sass-loader/dist/cjs.js??ref--8-oneOf-1-3!../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../node_modules/vue-loader/dist/index.js??ref--0-1!./MessagesHeader.vue?vue&type=style&index=0&id=4e53a512&lang=scss&scoped=true\"","export * from \"-!../../../node_modules/mini-css-extract-plugin/dist/loader.js??ref--8-oneOf-1-0!../../../node_modules/css-loader/dist/cjs.js??ref--8-oneOf-1-1!../../../node_modules/vue-loader-v16/dist/stylePostLoader.js!../../../node_modules/postcss-loader/src/index.js??ref--8-oneOf-1-2!../../../node_modules/sass-loader/dist/cjs.js??ref--8-oneOf-1-3!../../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../../node_modules/vue-loader/dist/index.js??ref--0-1!./MessageItem.vue?vue&type=style&index=0&id=c8530324&lang=scss&scoped=true\""],"sourceRoot":""}